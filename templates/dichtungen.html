<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8">
  <title>Dichtungen verwalten – Packlistenconverter</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">

  <style>
    :root{
      --bg-light: #f4ffe9;
      --bg-page: #f9fff4;
      --card-bg: #ffffff;
      --accent: #6bdc5c;
      --accent-dark: #41b936;
      --accent-soft: #d9f7d4;
      --text-main: #1a1a1a;
      --text-muted: #6b7280;
      --danger-bg: #fee2e2;
      --danger-border: #fecaca;
      --danger-text: #b91c1c;
      --border-subtle: #e5e7eb;
    }

    *{box-sizing:border-box;}

    body{
      margin:0;
      min-height:100vh;
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:radial-gradient(circle at top, var(--bg-light) 0, #ffffff 60%);
      color:var(--text-main);
    }

    .page{
      max-width:1200px;
      margin:0 auto;
      padding:32px 16px 40px;
    }

    header.hero{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:24px;
      margin-bottom:32px;
    }

    .hero-left h1{
      margin:10px 0 8px;
      font-size:28px;
      font-weight:700;
    }

    .hero-pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:4px 12px;
      border-radius:999px;
      background:var(--accent-soft);
      color:#166534;
      font-size:13px;
      font-weight:500;
    }
    .hero-pill-dot{
      width:10px;height:10px;
      border-radius:999px;
      background:#22c55e;
      box-shadow:0 0 0 3px rgba(34,197,94,0.25);
    }

    .hero-sub{
      margin:0;
      font-size:15px;
      color:var(--text-muted);
    }

    .hero-right{
      display:flex;
      align-items:flex-start;
      gap:8px;
    }

    .btn{
      border:none;
      border-radius:999px;
      padding:9px 16px;
      font-size:14px;
      cursor:pointer;
      text-decoration:none;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      white-space:nowrap;
    }
    .btn-primary{
      background:linear-gradient(135deg, var(--accent) 0%, var(--accent-dark) 100%);
      color:#fff;
      box-shadow:0 10px 25px rgba(22,163,74,0.35);
    }
    .btn-primary:hover{
      filter:brightness(1.05);
    }
    .btn-secondary{
      background:#ffffff;
      color:#111827;
      border:1px solid #d1d5db;
      box-shadow:0 8px 20px rgba(15,23,42,0.08);
    }
    .btn-secondary:hover{
      background:#f9fafb;
    }

    main.content{
      display:flex;
      flex-direction:column;
      gap:24px;
    }

    .card{
      background:var(--card-bg);
      border-radius:24px;
      padding:24px 24px 22px;
      box-shadow:0 25px 60px rgba(15,23,42,0.10);
    }

    .card h2{
      margin:0 0 4px;
      font-size:20px;
    }
    .card-sub{
      margin:0 0 18px;
      font-size:14px;
      color:var(--text-muted);
    }

    .dichtung-header-row{
      display:grid;
      grid-template-columns: 2.5fr 1fr 1fr 1.2fr 0.8fr;
      gap:10px;
      font-size:12px;
      color:var(--text-muted);
      padding:6px 8px 4px;
      border-bottom:1px solid var(--border-subtle);
    }

    .dichtung-list{
      margin-top:4px;
      display:flex;
      flex-direction:column;
      gap:8px;
    }

    .dichtung-row{
      display:grid;
      grid-template-columns: 2.5fr 1fr 1fr 1.2fr 0.8fr;
      gap:10px;
      align-items:center;
      padding:8px 8px;
      border-radius:12px;
      border:1px solid #e5e7eb;
      background:#f9fafb;
    }

    .dichtung-row:nth-child(odd){
      background:#ffffff;
    }

    .field-input{
      width:100%;
      padding:7px 9px;
      border-radius:10px;
      border:1px solid #d1d5db;
      background:#ffffff;
      font-size:13px;
    }
    .field-input:focus{
      outline:none;
      border-color:var(--accent-dark);
      box-shadow:0 0 0 1px var(--accent-dark),0 0 0 3px rgba(34,197,94,0.16);
      background:#ffffff;
    }

    .badge-toggle{
      border-radius:999px;
      border:1px solid #d4d4d8;
      padding:6px 10px;
      font-size:12px;
      background:#f4f4f5;
      color:#4b5563;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:6px;
      white-space:nowrap;
    }
    .badge-toggle span.dot{
      width:8px;height:8px;border-radius:999px;background:#d4d4d8;
    }
    .badge-toggle.active{
      background:#dcfce7;
      border-color:#22c55e;
      color:#166534;
    }
    .badge-toggle.active span.dot{
      background:#22c55e;
    }

    .btn-link{
      border:none;
      background:transparent;
      padding:0;
      font-size:12px;
      cursor:pointer;
      text-decoration:underline;
    }
    .btn-link.danger{
      color:#b91c1c;
    }

    .add-row{
      margin-top:12px;
      display:flex;
      justify-content:flex-start;
    }

    .btn-ghost{
      border-radius:999px;
      border:1px dashed #cbd5f5;
      background:#f9fafb;
      padding:7px 14px;
      font-size:13px;
      color:#4b5563;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:6px;
    }
    .btn-ghost:hover{
      background:#eef2ff;
    }

    .save-row{
      margin-top:18px;
      display:flex;
      justify-content:flex-end;
      gap:10px;
      align-items:center;
    }

    .hint-text{
      font-size:12px;
      color:var(--text-muted);
    }

    .toast{
      position:fixed;
      bottom:20px;
      right:20px;
      padding:10px 14px;
      border-radius:999px;
      background:#16a34a;
      color:#ffffff;
      font-size:13px;
      box-shadow:0 12px 30px rgba(22,163,74,0.45);
      opacity:0;
      pointer-events:none;
      transform:translateY(10px);
      transition:all .25s ease-out;
    }
    .toast.show{
      opacity:1;
      pointer-events:auto;
      transform:translateY(0);
    }

    .toast.error{
      background:#dc2626;
      box-shadow:0 12px 30px rgba(220,38,38,0.45);
    }

    .card-hints h3{
      margin:0 0 6px;
      font-size:15px;
    }
    .card-hints ul{
      margin:0;
      padding-left:18px;
      font-size:13px;
      color:var(--text-muted);
    }
    .card-hints li{
      margin-bottom:4px;
    }

    footer{
      margin-top:24px;
      font-size:12px;
      color:#9ca3af;
    }

    @media (max-width:820px){
      .dichtung-header-row,
      .dichtung-row{
        grid-template-columns: 2.2fr 1fr 1fr 1.4fr 0.9fr;
      }
    }

    @media (max-width:640px){
      header.hero{
        flex-direction:column;
        align-items:flex-start;
      }
    }
  </style>
</head>
<body>
<div class="page">
  <header class="hero">
    <div class="hero-left">
      <div class="hero-pill">
        <span class="hero-pill-dot"></span>
        <span>Zoho CRM · Packlistenconverter</span>
      </div>
      <h1>Dichtungen verwalten</h1>
      <p class="hero-sub">
        Lege fest, welche Dichtungen im Export erscheinen, welche Standardwerte haben und in welcher Reihenfolge sie angezeigt werden.
      </p>
    </div>
    <div class="hero-right">
      <a href="{{ url_for('index') }}" class="btn btn-secondary">
        ← Zurück zum Konverter
      </a>
    </div>
  </header>

  <main class="content">
    <section class="card">
      <h2>Dichtungs-Liste</h2>
      <p class="card-sub">
        Hier kannst du Dichtungen hinzufügen, Reihenfolge &amp; Standardwerte einstellen und festlegen, welche Dichtungen immer angezeigt werden.
      </p>

      <div class="dichtung-header-row">
        <div>Name</div>
        <div>Standardwert</div>
        <div>Reihenfolge</div>
        <div>Standard-Dichtung</div>
        <div>Aktion</div>
      </div>

      <div id="dichtungList" class="dichtung-list">
        <!-- Zeilen werden per JS eingefügt -->
      </div>

      <div class="add-row">
        <button type="button" class="btn-ghost" id="addRowBtn">
          <span>＋</span> Neue Dichtung hinzufügen
        </button>
      </div>

      <div class="save-row">
        <span class="hint-text">
          Tipp: Standard-Dichtungen werden immer angezeigt, auch wenn in der Packliste kein Wert vorhanden ist.
        </span>
        <button type="button" class="btn btn-primary" id="saveBtn">
          Änderungen speichern
        </button>
      </div>
    </section>

    <section class="card card-hints">
      <h3>Wie funktioniert das?</h3>
      <ul>
        <li><strong>Name:</strong> muss exakt dem Spaltennamen aus deinem Monteur-Export entsprechen.</li>
        <li><strong>Standardwert:</strong> wird in der Zeile „zusätzliche Dichtungen“ automatisch eingetragen.</li>
        <li><strong>Reihenfolge:</strong> kleinere Zahlen werden weiter links angezeigt; leere Felder werden hinten einsortiert.</li>
        <li><strong>Standard-Dichtung:</strong> diese Dichtungen werden immer im Export angezeigt, auch wenn alle Werte 0 sind.</li>
      </ul>
    </section>
  </main>

  <footer>
    © 2025 Fabio Starz · Packlistenconverter für Zoho CRM
  </footer>
</div>

<div id="toast" class="toast"></div>

<script>
  const initialDichtungen = {{ dichtungen|tojson|safe }};

  const listEl = document.getElementById('dichtungList');
  const addRowBtn = document.getElementById('addRowBtn');
  const saveBtn = document.getElementById('saveBtn');
  const toastEl = document.getElementById('toast');

  function showToast(message, isError=false){
    toastEl.textContent = message;
    toastEl.classList.remove('error');
    if(isError) toastEl.classList.add('error');
    toastEl.classList.add('show');
    setTimeout(()=> toastEl.classList.remove('show'), 2600);
  }

  function createRow(data){
    const row = document.createElement('div');
    row.className = 'dichtung-row';

    const name = data && data.name ? data.name : '';
    const defVal = data && (data.default_value !== undefined && data.default_value !== null)
                   ? data.default_value : '';
    const order = data && (data.order !== undefined && data.order !== null && data.order !== '')
                   ? data.order : '';
    const always = data && data.always_show ? true : false;

    row.innerHTML = `
      <input class="field-input name-input" type="text" placeholder="z.B. 10/5_S" value="${name}">
      <input class="field-input def-input" type="number" step="0.01" min="0" placeholder="0" value="${defVal}">
      <input class="field-input order-input" type="number" step="1" min="1" placeholder="" value="${order}">
      <button type="button" class="badge-toggle standard-toggle">
        <span class="dot"></span>
        <span class="label"></span>
      </button>
      <button type="button" class="btn-link danger remove-btn">Entfernen</button>
    `;

    const toggleBtn = row.querySelector('.standard-toggle');
    const labelSpan = toggleBtn.querySelector('.label');

    function updateToggle(active){
      if(active){
        toggleBtn.classList.add('active');
        labelSpan.textContent = 'Standard';
        row.dataset.standard = 'true';
      }else{
        toggleBtn.classList.remove('active');
        labelSpan.textContent = 'Kein Standard';
        row.dataset.standard = 'false';
      }
    }

    updateToggle(always);

    toggleBtn.addEventListener('click', () => {
      const activeNow = row.dataset.standard === 'true';
      updateToggle(!activeNow);
    });

    row.querySelector('.remove-btn').addEventListener('click', () => {
      if(confirm('Diese Dichtung wirklich entfernen?')){
        row.remove();
      }
    });

    listEl.appendChild(row);
  }

  function loadInitial(){
    if(Array.isArray(initialDichtungen) && initialDichtungen.length){
      initialDichtungen.forEach(d => createRow(d));
    }else{
      // eine leere Zeile, falls noch nichts existiert
      createRow({});
    }
  }

  addRowBtn.addEventListener('click', () => createRow({}));

  saveBtn.addEventListener('click', async () => {
    const rows = listEl.querySelectorAll('.dichtung-row');
    const result = [];

    rows.forEach(row => {
      const name = row.querySelector('.name-input').value.trim();
      const defStr = row.querySelector('.def-input').value.trim();
      const orderStr = row.querySelector('.order-input').value.trim();
      const always = row.dataset.standard === 'true';

      if(!name){
        return; // leere Zeilen ignorieren
      }

      let defVal = 0;
      if(defStr !== ''){
        const n = Number(defStr.replace(',', '.'));
        defVal = isNaN(n) ? 0 : n;
      }

      let orderVal = '';
      if(orderStr !== ''){
        const o = parseInt(orderStr, 10);
        orderVal = isNaN(o) ? '' : o;
      }

      result.push({
        name: name,
        always_show: always,
        default_value: defVal,
        order: orderVal
      });
    });

    try{
      const resp = await fetch("{{ url_for('manage_dichtungen') }}", {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify({ dichtungen: result })
      });

      if(!resp.ok){
        throw new Error("Serverfehler");
      }
      showToast("Dichtungen gespeichert ✔");
    }catch(e){
      console.error(e);
      showToast("Fehler beim Speichern der Dichtungen", true);
    }
  });

  loadInitial();
</script>
</body>
</html>
